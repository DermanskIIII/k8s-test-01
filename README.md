# k8s-test-01
Тестовое задание. Ansible, K8s

# Состав репозитория:

**./Ansible** -- плейбуки, роли, inventory Ansible.

**./Ansible/inventory/hosts.yml** -- инвентарь Ansible. Необходимо заполнить перед использованием. Группы master и worker содержат соответствующие ноды кластера K8s. Master-нода должна быть только одна.
  
**./Ansible/ansible_prepare.yml** -- подготавливает хосты к управлению с помощью Ansible. Перед выполнением требуется в 27 строке файла заполнить содержимое публичного ключа. 
Выполнять с указанием пользователя с доступом sudo: 
    
    ansible-playbook ./ansible_prepare.yml -i ./inventory/hosts.yml -u myuser
  
**./Ansible/deployment.yml** -- выполняет развертывание кластера K8s, без отдельного etcd-кластера. Добавляет на мастер-ноде пользователя kube, с конфигом, готовым для работы с kubectl и helm. Устанавливает в кластер драйвер сети Calico. Устанавливает на мастер-ноду helm. С помощью helm создает nginx-ingress-controller с внешним адресом мастер-ноды.

**./k8s** -- манифесты для развертывания в K8s-кластере простого веб-приложения (web -- nginx; app -- php-fpm; db -- PostgreSQL). "Приложение" является "заглушкой" -- оно не имеет никаких функций, является на самом деле просто группой ненастроенных контейнеров и нужно только для демонстрации факта развёртывания, а также настройки сетевых политик доступа (ограничиваются любые сетевые подключения, кроме как в направлениях WEB -> APP -> DB, а также запросов к DNS (UDP/53) с любых подов приложения. Проверить работу сетевых политик можно с помощью инструментов сетевой диагностики вроде ncat и подобных. 

Для развертывания кластера K8s выполнить плейбук ./Ansible/deployment.yml

Для развертывания "приложения":

    kubectl apply -f ./k8s/deployment-*    # -- пространства имён, деплойменты компонентов приложения, сервисы
    kubectl apply -f ./k8s/ingress.yaml    # -- ingress для доступа к web
    kubectl apply -f ./k8s/np-all.yaml     # -- NetworkPolicies
